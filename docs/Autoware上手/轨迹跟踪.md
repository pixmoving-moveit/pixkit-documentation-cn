
# 轨迹跟踪
> 本文档将介绍轨迹跟踪模块的文件结构，各通讯节点之间的数据交互，以及启动文件和算法的参数配置。 
## 概述
轨迹跟踪模块是Autoware中的核心模块，它负责将轨迹规划模块下发的轨迹点作为参考轨迹，通过横向和纵向控制器，实现车辆在轨迹上的跟踪。   

## 文件结构
轨迹跟踪模块位于[autoware.universe/control](https://github.com/autowarefoundation/autoware.universe/tree/main/control)，结构如下:     

|文件目录                           | 简要说明  
|----------------------------------|------------------------------------------------------------------------------------------------------------------------  
|autonomous_emergency_braking      | 自动紧急制动(AEB)，防止预测轨迹(由横向控制器提供)与障碍物发生碰撞
|control_performance_analysis      | 控制性能分析，分析轨迹跟踪控制模块的跟踪性能并监控车辆的行驶状态
|external_cmd_selector             | 外部命令选择器，根据输入指令与当前模式，切换车辆模式（遥控模式/自动驾驶模式）
|joy_controller                    | 手柄控制器，将遥控器消息转换为autoware所需要车辆控制命令（例如：转向角，档位，转向信号，启动键等）
|mpc_lateral_controller            | mpc横向控制器，线性模型预测控制（MPC）算法的实现。它将生成横向控制指令（转向角和转向速率）来跟踪路径，并使用车辆模型来模拟控制命令产生的轨迹。 
|obstacle_collision_checker        | 障碍物碰撞检查器，检查由横向控制器生成预测轨迹的对障碍物碰撞检测，并在发现碰撞时发布诊断错误
|operation_mode_transition_manager | 操作模式转换管理器，负责管理 Autoware 系统的不同操作模式。可能的模式是：`Autonomous`，`Local`，`Remote`，'`Stop`',
|pid_longitudinal_controller       | PID纵向控制器，将Planner模块下发轨迹点速度作为参考速度，使用PID算法计算车辆加速度控制信号，以实现在通过目标轨迹时达到指定的目标速度。
|pure_pursuit                      | 纯追踪横向控制器，纯跟踪(pure_pursuit)算法的实现，它将生成横向控制指令（转向角和转向速率）来跟踪路径。 
|shift_decider                     | 档位决策器，根据有跟踪控制器输出的控制指令来确定档位大小
|trajectory_follower_base          | 轨迹跟踪控制器接口，为`trajectory_follower_node`提供横向和纵向的控制器提供统一规范的接口
|trajectory_follower_node          | 轨迹跟踪控制器节点，它是在派生自`trajectory_follower_base`的控制器类中实现的功能节点，生成控制指令去跟踪参考轨迹
|vehicle_cmd_gate                  | 车辆命令油门，从紧急处理程序、计划模块、外部控制器获取信息并向车辆发送消息的包

  
## 数据交互
#### 消息传递
略（待完善）

#### 关键话题订阅列表   
略（待完善）

#### 关键话题发布列表
略（待完善）

#### 详细话题订阅列表
|话题名称 | 消息类型 | 订阅节点
|----------------------------------------------------------|--------------------------------------------------------|----------------------------------------------
|/autoware/state                                           | autoware_auto_system_msgs/msg/AutowareState            | shift_decider
|/control/command/control_cmd                              | autoware_auto_control_msgs/msg/AckermannControlCommand | operation_mode_transition_manager
|/control/gate_mode_cmd                                    | tier4_control_msgs/msgs/GateMode                       | vehicle_cmd_gate
|/control/shift_decider/gear_cmd                           | autoware_auto_vehicle_msgs/msg/GearCommand             | vehicle_cmd_gate
|/control/trajectory_follower/control_cmd                  | autoware_auto_control_msgs/msg/AckermannControlCommand | shift_decider
|/control/trajectory_follower/lateral/predicted_trajectory | autoware_auto_planning_msgs/msg/Trajectory             | autonomous_emergency_braking<br> lane_departure_checker<br> obstacle_collision_checker<br> 
|/control/vehicle_cmd_gate/operation_mode                  | autoware_adapi_v1_msgs/msg/OperationModeState          | operation_mode_transition_manager
|/external/selected/control_cmd                            | autoware_auto_control_msgs/msg/AckermannControlCommand | vehicle_cmd_gate
|/external/selected/hazard_lights_cmd                      | autoware_auto_vehicle_msgs/msg/HazardLightsCommand     | vehicle_cmd_gate
|/external/selected/gear_cmd                               | autoware_auto_vehicle_msgs/msg/GearCommand             | vehicle_cmd_gate
|/external/selected/heartbeat                              | tier4_external_api_msgs/msg/Heartbeat                  | vehicle_cmd_gate
|/localization/acceleration                                | geometry_msgs/msgs/AccelWithCovarianceStamped          | trajectory_follower_node<br> vehicle_cmd_gate
|/localization/kinematic_state                             | nav_msgs/msgs/Odometry                                 | autonomous_emergency_braking<br> lane_departure_checker<br> obstacle_collision_checker<br> operation_mode_transition_manager<br>  trajectory_follower_node<br> vehicle_cmd_gate  
|/map/vector_map                                           | autoware_auto_mapping_msgs/msg/HADMapBin               | lane_departure_checker<br> obstacle_collision_checker
|/perception/obstacle_segmentation/pointcloud              | sensor_msgs/msg/PointCloud2                            | autonomous_emergency_braking<br> obstacle_collision_checker
|/planning/hazard_lights_cmd                               | autoware_auto_vehicle_msgs/msg/HazardLightsCommand     | vehicle_cmd_gate 
|/planning/mission_planning/route                          | autoware_auto_planning_msgs/msg/LaneletRoute           | lane_departure_checker<br> obstacle_collision_checker
|/planning/scenario_planning/trajectory                    | autoware_auto_planning_msgs/msg/Trajectory             | trajectory_follower_node<br> obstacle_collision_checker<br> operation_mode_transition_manager <br> lane_departure_checker
|/planning/turn_indicators_cmd                             | autoware_auto_vehicle_msgs/msg/TurnIndicatorsCommand   | vehicle_cmd_gate
|/sensing/imu/imu_data                                     | sensor_msgs/msg/Imu                                    | autonomous_emergency_braking
|/system/emergency/control_cmd                             | autoware_auto_control_msgs/msg/AckermannControlCommand | vehicle_cmd_gate
|/system/emergency/gear_cmd                                | autoware_auto_vehicle_msgs/msg/GearCommand             | vehicle_cmd_gate
|/system/emergency/hazard_lights_cmd                       | autoware_auto_vehicle_msgs/msg/HazardLightsCommand     | vehicle_cmd_gate
|/system/fail_safe/mrm_state                               | autoware_adpi_v1_msgs/msgs/MrmState                    | vehicle_cmd_gate 
|/system/operation_mode/state                              | autoware_adpi_v1_msgs/msgs/OperationModeState          | vehicle_cmd_gate<br> trajectory_follower_node
|/vehicle/status/control_mode                              | autoware_auto_vehicle_msgs/msg/ControlMoedReport       | operation_mode_transition_manager
|/vehicle/status/gear_status                               | autoware_auto_vehicle_msgs/msg/GearReport              | vehicle_cmd_gate
|/vehicle/status/steering_status                           | autoware_auto_vehicle_msgs/msgs/SteeringReport         | operation_mode_transition_manager<br> trajectory_follower_node<br> vehicle_cmd_gate<br> 
|/vehicle/status/velocity_status                           | autoware_auto_vehicle_msgs/msgs/VelocityReport         | autonomous_emergency_braking



#### 详细话题发布列表
|话题名称 | 消息类型 | 发布节点
|----------------------------------------------------------|--------------------------------------------------------|----------------------------------------------
|/api/autoware/get/engage                                  | autoware_auto_vehicle_msgs/msg/Engage                  | vehicle_cmd_gate
|/api/autoware/get/emergency                               | autoware_auto_vehicle_msgs/msg/Emergency               | vehicle_cmd_gate
|/control/command/emergency_cmd                            |tire4_vehicle_msgs/msg/VehicleEmergencyStamped          | vehicle_cmd_gate      
|/control/command/control_cmd                              | autoware_auto_control_msgs/msg/AckermannControlCommand | vehicle_cmd_gate
|/control/command/gear_cmd                                 |autoware_auto_vehicle_msgs/msg/GearCommand              | vehicle_cmd_gate
|/control/command/turn_indicators_cmd                      |autoware_auto_vehicle_msgs/msg/TurnIndicatorsCommand    | vehicle_cmd_gate
|/control/command/hazard_lights_cmd                        | autoware_auto_vehicle_msgs/msg/HazardLightsCommand     | vehicle_cmd_gate
|/control/current_gate_mode                                |tire4_control_msgs/msg/GateMode                         | vehicle_cmd_gate
|/control/shift_decider/gear_cmd                           |autoware_auto_vehicle_msgs/msg/GearCommand              | shift_decider
|/control/trajectory_follower/control_cmd                  |autoware_auto_control_msgs/msg/AckermannControlCommand  | trajectory_follower_node
|/control/trajectory_follower/lateral/predicted_trajectory |autoware_auto_planning_msgs/msg/Trajectory              | trajectory_follower_node
|/control/trajectory_follower/lateral/diagnostic           |tier4_debug_msgs/Float32MultiArrayStamped               | trajectory_follower_node
|/control/trajectory_follower/longitudinal/slope_angle     |tier4_debug_msgs/Float32MultiArrayStamped               | trajectory_follower_node
|/control/trajectory_follower/longitudinal/diagnostic      |tier4_debug_msgs/Float32MultiArrayStamped               | trajectory_follower_node
|/control/vehicle_cmd_gate/operation_mode | autoware_adapi_v1_msgs/msgs/OperationModeState                          | vehicle_cmd_gate

## 参数配置 
该模块各节点的配置文件位置：[autoware_launch/config/control](https://github.com/autowarefoundation/autoware_launch/tree/main/autoware_launch/config/control)                                                                                                                     
>注意：autoware.universe/control/*/config具有与autoware_launch/config/control相同的配置文件，但默认是从autoware_launch/config/control加载的

#### 关键配置参数
|参数名称 |参数类型| 参数描述 | 可选值 
|----------------------------------|--------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------
|lateral_controller_mode           | string | 在[启动时](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/launch/components/tier4_control_component.launch.xml)，加载指定的横向跟踪控制器                                                         | `mpc`（默认），`pure_pursuit` 
|mpc_weight_steering_input         | double | 在[mpc](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml)中表示转向输入权重，当权重增大，转向更平稳，但会使得车辆与参考轨迹之间的状态误差增大           | 0~inf
|mpc_weight_lat_error              | double | 在[mpc](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml)中表示横向误差权重，当权重越大，车辆更贴近参考轨迹，但容易发生振荡                          | 0~inf
|mpc_weight_heading_error          | double | 在[mpc](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml)中表示航向误差权重，当权重越大，车辆与轨迹平行度更高，但可能会使得横向误差收敛速度降低         | 0~inf
|mpc_weight_terminal_lat_error     | double | 在[mpc](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml)中表示末端处的横向误差，当权重越大，车辆末端终点的横向误差更小，但可能影响行使过程的稳定性      | 0~inf
|mpc_weight_terminal_heading_error | double | 在[mpc](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml)中表示末端处的航向误差，当权重越大，车辆末端终点的航向误差更小，但可能影响行使过程的稳定性       | 0~inf
|mpc_prediction_horizon            | double | 在[mpc](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml)中表示预测时间窗口，该参数越大，车辆的预测时间越长，提高跟踪性能，但计算量会增大               | 0~inf 单位为秒
|mpc_prediction_dt                 | double | 在[mpc](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/lateral/mpc.param.yaml)中表示预测时间间隔，该参数越小，车辆的预测时间间隔越小，提高跟踪性能，但计算量会增大           | 0~inf 单位为秒
|kp                                | double | 在[pid](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/longitudinal/pid.param.yaml)中表示纵向误差的权重，该参数越大，误差越小，但过大会使得电机输出过大，需要合理设置范围 | 0~inf
|ki                                | double | 在[pid](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/longitudinal/pid.param.yaml)中表示纵向累积误差的权重，该参数会使得纵向误差越来越小，需要合理设置范围              | 0~inf
|kd                                | double | 在[pid](https://github.com/autowarefoundation/autoware_launch/blob/main/autoware_launch/config/control/trajectory_follower/longitudinal/pid.param.yaml)中表示纵向误差的变化率权重，该参数可以减少纵向误差的的振荡，需要合理设置范围           | 0~inf

#### 详细配置参数
关于各节点详细参数配置，如下所示:  

|节点名称 | 文件位置 |
|--------|---------|
|autonomous_emergency_braking      | <https://autowarefoundation.github.io/autoware.universe/main/control/autonomous_emergency_braking/#parameters>
|control_performance_analysis      | <https://autowarefoundation.github.io/autoware.universe/main/control/control_performance_analysis/#parameters> 
|joy_controller                    | <https://autowarefoundation.github.io/autoware.universe/main/control/joy_controller/#parameters>
|lane_departure_checker            | <https://autowarefoundation.github.io/autoware.universe/main/control/lane_departure_checker/#parameters>
|mpc_lateral_controller            | <https://autowarefoundation.github.io/autoware.universe/main/control/mpc_lateral_controller/#parameter-description>
|obstacle_collision_checker        | <https://autowarefoundation.github.io/autoware.universe/main/control/obstacle_collision_checker/#parameters>
|operation_mode_transition_manager | <https://autowarefoundation.github.io/autoware.universe/main/control/operation_mode_transition_manager/#parameters>
|pid_longitudinal_controller       | <https://autowarefoundation.github.io/autoware.universe/main/control/pid_longitudinal_controller/#parameter-description>
|pure_pursuit                      | None
|shift_decider                     | None
|vehicle_cmd_gate                  | <https://autowarefoundation.github.io/autoware.universe/main/control/vehicle_cmd_gate/#parameters>


## 车辆运动学模型
根据给出的参考文献,具有四轮转向执行机构的车辆运动学模型<sup>[1]</sup>可以表示为：
![four-wheel-steering-model](images/four-wheel-steering-model.png)

$$
\begin{aligned}
\dot{X} & =V \cos (\psi+\beta) \\
\dot{Y} & =V \sin (\psi+\beta) \\
\dot{\psi} & =\frac{V \cos (\beta)}{\ell_f+\ell_r}\left(\tan \left(\delta_f\right)-\tan \left(\delta_r\right)\right)
\end{aligned}
$$

其中，$X$、$Y$、$\psi$分别表示车辆在全局坐标系下的位置和航向角，$\beta$表示车辆的侧偏角，$V$表示车辆的速度，$\delta_f$、$\delta_r$分别表示前后轮转角，$\ell_f$、$\ell_r$分别表示前后轮距。
假设车辆的侧偏角为0，即车辆的航向角与车辆的前进方向一致，并且前后轮转角是同角异向的，那么车辆的运动学模型可以简化为：

$$
\begin{aligned}
\dot{X} & =V \cos (\psi) \\
\dot{Y} & =V \sin (\psi) \\
\dot{\psi} & =\frac{2 V \tan \left(\delta_f\right)}{\ell_f+\ell_r} 
\end{aligned}
$$

## 参考资料
[1]: Rajamani, Rajesh. Vehicle dynamics and control. Springer Science & Business Media, 2011.
